name: Weekly-Fusion Crime Brief

on:
  schedule:
    - cron: '0 3 * * 0'          # 03:00 UTC every Sunday
  workflow_dispatch:            # manual trigger

jobs:
  weekly-fusion:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}   # guarantee repo-root

    steps:
      # ---------- 1.  check out repo ----------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- 2.  python 3.11 ----------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # ---------- 3.  install dependencies ----------
      - name: Install Python packages
        run: |
          # CPU-only PyTorch wheel (avoids 2 GB GPU download)
          pip install --extra-index-url https://download.pytorch.org/whl/cpu \
                      torch==2.1.0+cpu torchvision==0.16.0+cpu torchaudio==2.1.0+cpu
          # everything else
          pip install -r requirements.txt

      # ---------- 4.  download spaCy model ----------
      - name: Cache & install spaCy multilingual model
        run: |
          python -m spacy download xx_ent_wiki_sm

      # ---------- 5.  run weekly collector + NLP ----------
      - name: Collate & analyse last 6 full days
        env:
          GMAIL_USER:                ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD:        ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_TO:                  ${{ secrets.EMAIL_TO }}
          SENTINEL_API_KEY:          ${{ secrets.SENTINEL_API_KEY }}
          TELEGRAM_API_ID:           ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH:         ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_SESSION_STRING:   ${{ secrets.TELEGRAM_SESSION_STRING }}
        run: |
          python src/analyst/weekly_fusion.py
          python -m src.main

      # ---------- 6.  render PDF ----------
      - name: Render HTML â†’ PDF
        run: python src/render/pdf.py

      # ---------- 7.  e-mail the bundle ----------
      - name: Send e-mail
        env:
          GMAIL_USER:         ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_TO:           ${{ secrets.EMAIL_TO }}
        run: python src/render/email.py
